<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Piotrflix Log Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1e1e1e">

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #1e1e1e;
        color: #d4d4d4;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }
    .container {
        width: 95%;
        max-width: 500px;
        padding: 20px;
        background: #252525;
        border-radius: 12px;
        box-shadow: 0 0 14px rgba(0,0,0,0.5);
    }
    .logo {
        width: 180px;
        display: block;
        margin: 0 auto 20px;
    }
    input {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #333;
        background: #111;
        color: #fff;
        margin-top: 6px;
    }
    button {
        width: 100%;
        padding: 12px;
        margin-top: 15px;
        background: #ff3d00;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
    }
    button:hover { background: #ff5722; }

    #error {
        margin-top: 10px;
        color: #ff4444;
        font-weight: bold;
        text-align: center;
    }

    #logsView { display: none; }
    #logBox {
        width: 100%;
        height: 400px;
        background: #111;
        color: #d4d4d4;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #333;
        overflow-y: auto;
        white-space: pre-wrap;
        font-family: Consolas, monospace;
    }

    #pauseBtn {
        background: #ff3d00;
        margin-bottom: 15px;
    }
</style>
</head>
<body>

<div class="container">

    <!-- LOGIN -->
    <div id="loginView">
        <img src="logos/logo.png" class="logo">

        <label>Login:</label>
        <input type="text" id="login">

        <label>Hasło:</label>
        <input type="password" id="password">

        <div id="error"></div>

        <button onclick="tryLogin()">Zaloguj</button>
    </div>

    <!-- LOGS -->
    <div id="logsView">
        <img src="logos/logo.png" class="logo">

        <h2 style="text-align:center; color:#ff3d00;">API LOGS</h2>

        <button id="pauseBtn" onclick="togglePause()">⏸ Pauza</button>

        <div id="logBox"></div>
    </div>

</div>

<script>
const SERVER_URL = "https://api.pkportfolio.pl";

let loginUser = "";
let loginPass = "";
let paused = false;

// --- AUTH HEADER ---
function authHeader(user, pwd) {
    return "Basic " + btoa(user + ":" + pwd);
}

// --- FETCH LOGS ---
async function fetchLogs() {
    try {
        const r = await fetch(`${SERVER_URL}/logs/tail`, {
            headers: { "Authorization": authHeader(loginUser, loginPass) }
        });

        if (r.status === 401) {
            return { error: true, msg: "❌ Błędny login lub hasło (401)" };
        }

        const json = await r.json();
        return { error: false, log: json.log };

    } catch (e) {
        return { error: true, msg: "⚠️ Błąd połączenia: " + e };
    }
}

// --- LOGIN ---
async function tryLogin() {
    const user = document.getElementById("login").value.trim();
    const pass = document.getElementById("password").value.trim();
    const err = document.getElementById("error");

    if (!user || !pass) {
        err.innerText = "⚠️ Wypełnij login i hasło!";
        return;
    }

    const test = await fetchLogs(user, pass);

    loginUser = user;
    loginPass = pass;

    if (test.error) {
        err.innerText = test.msg;
        return;
    }

    document.getElementById("loginView").style.display = "none";
    document.getElementById("logsView").style.display = "block";
}

// --- LOG UPDATER ---
async function updateLogs() {
    if (paused) return;

    const box = document.getElementById("logBox");
    const res = await fetchLogs();

    if (res.error) {
        box.textContent = res.msg;
        return;
    }

    box.textContent = res.log;
    box.scrollTop = box.scrollHeight;
}

setInterval(updateLogs, 2000);

function togglePause() {
    paused = !paused;
    document.getElementById("pauseBtn").innerText =
        paused ? "▶ Wznów" : "⏸ Pauza";

    if (!paused) updateLogs();
}

// --- PWA Service Worker ---
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
