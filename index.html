<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">

<title>Piotrflix Log Viewer</title>

<!-- FULLSCREEN + NO ZOOM -->
<meta name="viewport"
      content="width=device-width, initial-scale=1.0,
               maximum-scale=1.0, user-scalable=no">

<meta name="theme-color" content="#1e1e1e">
<link rel="manifest" href="./manifest.json">

<style>
/* ================= GLOBAL ================= */
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background: #1e1e1e;
    font-family: Arial, sans-serif;
    color: #d4d4d4;
    overflow: hidden;
}

.app {
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: flex-start; /* WAŻNE */
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    box-sizing: border-box;
    overflow: hidden;
}

/* ================= LOGIN PANEL ================= */
#loginView {
    width: 95%;
    max-width: 480px;
    background: #252525;
    padding: 35px;
    border-radius: 16px;
    box-shadow: 0 0 25px rgba(0,0,0,0.55);
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 40px;
}

.login-inner {
    width: 100%;
    max-width: 330px;
}

.logo {
    width: 180px;
    margin-bottom: 20px;
}

label {
    margin-top: 10px;
    font-size: 15px;
}

input {
    width: 100%;
    padding: 12px;
    background: #111;
    border-radius: 8px;
    border: 1px solid #333;
    margin-top: 5px;
    font-size: 15px;
    color: #fff;
    box-sizing: border-box;
}

button {
    width: 100%;
    padding: 14px;
    background: #ff3d00;
    border-radius: 8px;
    border: none;
    font-size: 16px;
    font-weight: bold;
    color: white;
    margin-top: 20px;
    cursor: pointer;
}

button:hover {
    background: #ff5722;
}

#error {
    margin-top: 10px;
    color: #ff4444;
    text-align: center;
    font-weight: bold;
}

/* ================= LOGS PANEL ================= */
#logsView {
    display: none;
    width: 95%;
    max-width: 900px;

    height: calc(100% - 40px);
    margin-top: 20px;
    margin-bottom: 20px;

    padding: 25px;
    border-radius: 16px;
    background: #252525;
    box-shadow: 0 0 25px rgba(0,0,0,0.55);

    display: flex;
    flex-direction: column;
    align-items: center;
    box-sizing: border-box;
}

.logs-inner {
    width: 100%;
    max-width: 900px;
    display: flex;
    flex-direction: column;
    height: 100%;
}

.header-logo {
    width: 180px;
    margin-bottom: 5px;
}

h2 {
    font-size: 22px;
    margin: 5px 0 15px 0;
    color: #ff3d00;
    text-align: center;
}

#pauseBtn {
    width: 100%;
    max-width: 300px;
}

/* ============== LOG BOX – FULLSCREEN INSIDE PANEL ============== */
#logBox {
    flex: 1;             /* wypełnia pozostałą przestrzeń */
    width: 100%;
    background: #111;
    border-radius: 12px;
    border: 1px solid #333;
    padding: 15px;
    margin-top: 15px;
    overflow-y: auto;
    font-family: Consolas, monospace;
    font-size: 14px;
    white-space: pre-wrap;
    box-sizing: border-box;
}
</style>
</head>

<body>
<div class="app">

    <!-- LOGIN PANEL -->
    <div id="loginView">
        <img src="./logos/logo.png" class="logo">

        <div class="login-inner">
            <label>Login:</label>
            <input id="login" type="text">

            <label>Hasło:</label>
            <input id="password" type="password">

            <div id="error"></div>
            <button onclick="tryLogin()">Zaloguj</button>
        </div>
    </div>

    <!-- LOGS PANEL -->
    <div id="logsView">
        <img src="./logos/logo.png" class="header-logo">

        <div class="logs-inner">
            <h2>API LOGS</h2>

            <button id="pauseBtn" onclick="togglePause()">⏸ Pauza</button>

            <div id="logBox"></div>
        </div>
    </div>

</div>

<script>
const SERVER_URL = "https://api.pkportfolio.pl";

let loginUser = "";
let loginPass = "";
let paused = false;

/* AUTH HEADER */
function authHeader(u, p) {
    return "Basic " + btoa(u + ":" + p);
}

/* FETCH LOGS */
async function fetchLogs() {
    try {
        const r = await fetch(`${SERVER_URL}/logs/tail`, {
            headers: { "Authorization": authHeader(loginUser, loginPass) }
        });

        if (r.status === 401)
            return { error: true, msg: "❌ Błędny login lub hasło (401)" };

        const json = await r.json();
        return { error: false, log: json.log };

    } catch (e) {
        return { error: true, msg: "⚠️ Błąd połączenia: " + e };
    }
}

/* LOGIN */
async function tryLogin() {
    const user = login.value.trim();
    const pass = password.value.trim();
    const err = document.getElementById("error");

    if (!user || !pass) {
        err.innerText = "⚠️ Wypełnij login i hasło!";
        return;
    }

    loginUser = user;
    loginPass = pass;

    const test = await fetchLogs();
    if (test.error) {
        err.innerText = test.msg;
        return;
    }

    loginView.style.display = "none";
    logsView.style.display = "flex";
}

/* UPDATE LOGS */
async function updateLogs() {
    if (paused) return;

    const box = document.getElementById("logBox");
    const res = await fetchLogs();

    if (res.error) {
        box.textContent = res.msg;
        return;
    }

    box.textContent = res.log;
    box.scrollTop = box.scrollHeight;
}

setInterval(updateLogs, 2000);

/* PAUSE BUTTON */
function togglePause() {
    paused = !paused;
    pauseBtn.innerText = paused ? "▶ Wznów" : "⏸ Pauza";
    if (!paused) updateLogs();
}

/* PWA SERVICE WORKER */
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js");
}
</script>

</body>
</html>
